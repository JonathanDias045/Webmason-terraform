**Documentation Terraform et ansible**

# Identifiant nécessaire

### Conteneur Hôte

- __root | webmason__
- __jdias | jdias__
```bash
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE5i68nOFjp7fkqqSctterFi9v5RgQ0YvXIqv3QimGYG utilisateur@DESKTOP-HRJ54SO
```
- __mbureau | mbureau__
```bash
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDXdtB+M6QXOtqTFm9SnoOVmaDwyHbS2L8LIFo6bXDA9bmIfVaI0z9HxMFYOzP+nCIKHWGeolng9jtGsb5HG3kJIdyh1oJyA7uusB2QdgffsMrRi40m7rgJ+SqwdT6UradbtbBftV8PUrWW/lrAERk2vG9a3PhqdZK294Ne6+dqP5e2n83IJazdNgwH4TtjpeZv3/wQ3kcZqQ0SAYD6DEeBCo2cq9Iltx3YFG7yB9yFB2MOuK+6+p/w2QvjKumaWHv3/8iFNFhjg8Vw9auOu4VHgAhqoySZLKXvbZWAW9qPqJ2TTwSesb2Z4ykiRcEPT+4IiyQUdfvs+WijxpTcvuUl36kXb6t6RHcl6ruKUw+CRQIjvqwzg32UqcB17NSBghjMJNjv2/8PpOkh++wQXOY2c5Lyt87Izds5dKH31CZKjug6ZdCGbkUniVNcOhSWsHQiNqWPxzwpxsEmJTEjjr26E76Dj71HHwzCxRC5argM/tymnLQuRdbQqywJ9e9+ZxFWuBWuJITDn1tYFhDoMD8t8AwiAi+m1re3lw6pgckhpZ0J4JHmy4vnEEk/6BNfgGrXLcqkKfSz4ZytA8sC7yuC9yc9GaoES62xaMDfOpyyMF0xvKdEoNAqBsf9xVY0S0CqqM+eX/tsMwegdqWAITkGmWEW4V+LVo6S2PaEdL+4fQ== bastien@MacBook-Air-de-Bastien.local
```
- __fbouloumie | fbouloumie__
```bash
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCrPnKKEB/rRdTzaBPHOPMq56tRf3MxutmVIQUGZij8U1dWffLYgpQjK4k+UygAZfYoYNiWRNkxBrK4ddqGtFqhRBY3IBTkHObGCS4yd6FvTcHsOut4Wog3P96KaEg4dNkMCVxCP8P/K6hqKqqznoL8hsBOAZPhdKqD6GRDzzBRzVtcrNw8/WKrlH3+pE3OJOZP7q9w+IeZFJh3WKEbqwMVzbtieaDffaU84LSONunpOs4RhlfAbG2QAKCKJh01uUOgFK4uBN4Q31Fj1yRAigGorv8NtIhTc51cC3C5jPxdh55vSSUuTXXqMgeyD8L2gvLBPNgh2VH0lfSNEFX5Iss821Zbnl/KI3XwXoiMnZO12le8KOKi0y73LAAmVEglaHVCluGnf1cTq3LLkLJArmYfE2Rvgf9o0JEsxpCixa06QHF6Z3SJVk6lHrLcce5YqRxxzjLxqXfU8dqdMM7M4pmwQh5FkKrOzcogWMSTPXWwmWmofVb4Gd1ZfQ30CTCnD0M= francois@DESKTOP-296E9TG
```
- __bfayant | bfayant__
```bash
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDXdtB+M6QXOtqTFm9SnoOVmaDwyHbS2L8LIFo6bXDA9bmIfVaI0z9HxMFYOzP+nCIKHWGeolng9jtGsb5HG3kJIdyh1oJyA7uusB2QdgffsMrRi40m7rgJ+SqwdT6UradbtbBftV8PUrWW/lrAERk2vG9a3PhqdZK294Ne6+dqP5e2n83IJazdNgwH4TtjpeZv3/wQ3kcZqQ0SAYD6DEeBCo2cq9Iltx3YFG7yB9yFB2MOuK+6+p/w2QvjKumaWHv3/8iFNFhjg8Vw9auOu4VHgAhqoySZLKXvbZWAW9qPqJ2TTwSesb2Z4ykiRcEPT+4IiyQUdfvs+WijxpTcvuUl36kXb6t6RHcl6ruKUw+CRQIjvqwzg32UqcB17NSBghjMJNjv2/8PpOkh++wQXOY2c5Lyt87Izds5dKH31CZKjug6ZdCGbkUniVNcOhSWsHQiNqWPxzwpxsEmJTEjjr26E76Dj71HHwzCxRC5argM/tymnLQuRdbQqywJ9e9+ZxFWuBWuJITDn1tYFhDoMD8t8AwiAi+m1re3lw6pgckhpZ0J4JHmy4vnEEk/6BNfgGrXLcqkKfSz4ZytA8sC7yuC9yc9GaoES62xaMDfOpyyMF0xvKdEoNAqBsf9xVY0S0CqqM+eX/tsMwegdqWAITkGmWEW4V+LVo6S2PaEdL+4fQ== bastien@MacBook-Air-de-Bastien.local
```
- __javond | javond__
```bash
ssh_key: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBnoxKR7llvIC/zepZokSb2FyqO69BVCiFAWKTULE4bL jerome@djay
```


# **Sommaire**
[**Presentation TERRAFORM**](#_toc167621238)

[**1. Qu'est-ce que Terraform ?**](#_toc167621239)

[**2. Fonctionnalités Principales**](#_toc167621240)

[**3. Avantages**](#_toc167621241)

[**5. Usage de Base**](#_toc167621242)

[**6. Dossier a modifier pour créer ou supprimer une VM**](#_toc167621243)

- [Paramètres Essentiels pour la Création d'une VM](#_toc167621244)

[**7. Communauté et Support**](#_toc167621245)

[**8. Conclusion**](#_toc167621246)

[**9. Présentation de Ansible**](#_toc167621247)

- [**Introduction**](#_toc167621248)

- [**Principales Caractéristiques**](#_toc167621249)

- [**Architecture**](#_toc167621250)

- [**Modification de Playbook package**](#_toc167621251)

- [Modification des packages](#_toc167621252)

- [Ajoutez ou suprimer une vm](#_toc167621253)

- [Déclarer une vm](#_toc167621254)

- [**Modification des utilisateur**](#_toc167621255)

- [**Cas d'Utilisation**](#_toc167621256)

- [**Avantages**](#_toc167621257)

- [**Conclusion**](#_toc167621258)

[**10. Lien entre terraform et ansible**](#_toc167621259)

- [**Configuration de Terraform**](#_toc167621260)

- [**Script Shell pour Exécuter les Playbooks Ansible**](#_toc167621261)

- [**Script Expect pour Gérer les Demandes de Mot de Passe**](#_toc167621262)

- [**Lancer la création et la configuration des VM**](#_toc167621263)



## Dossier a modifier pour créer ou suprimé une VM

Le fichier `nodes.auto.tfvars.json` permet de créer ou supprimer des machines virtuelles (VM).

Pour accéder à ce fichier, suivez ces étapes :

1. Allez dans le répertoire suivant en utilisant la commande :

     ```bash

     cd /home/mbureau/Webmason-terraform/terraform/

     ```

2. Une fois dans ce dossier, vous pouvez modifier le fichier `nodes.auto.tfvars.json` avec votre éditeur préféré.

Le contenu du fichier est le suivant :

```json
{

     "password": "Password",

     "ssh_public_keys": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC2c18uyQwwLoP5jQz2AMBtMFhZDPt7wcoNG38BwylxirItHE7jGlWl3Yf924Q7zpVcPyIVHKtQv3RZ1aF7u5SojGPJ+iOisPCg0K4n/OVNuRbgY4Ig4LAwJGkTAnC7ZOy3BQPUIbAu7n1RqFzDNI+/T8GdzJ7U3Trk+JmDjkLTJuK32DBjVig3oE0EmmAMcIMC1jd2QLrRnmN1a4TzhtFdPyCqJeJdhHFFJPgQb2zqmj9094z6vxWnU0scHbOUQrRgE77oi+UvsbXnrr+WCRldvZj9jf6wrAak6HXIDAjsnZ5HB7RVcAR5dUKGrTCJcCkLOetxf1HmFXs0EJ2oGC4jPO4GaALPSV11HTCCUQt07aS0tEk6qqxLvhLz3KrFuKnS8vtRTUsdESKczArxd3BaXwgDtuRWUbPhIMnR27JKL6UMTUEVvfRb4rYu1LdxRuxt1JLumwQlWjjFE4T30S11oaR/Ck1954tNCF1wwjmjqomUa2Xq/cXUUMmf+7SzUoU= mbureau@webmason",

     "target_node": "cfai2024",

     "pool": "jdias",

     "containers": [

     {

        "name": "bdd",

        "cpuunits": 256,

        "rootfs_size": "2G",

        "memory": 256,

        "ostemplate": "local:vztmpl/debian-12-standard_12.2-1_amd64.tar.zst",

        "ip6": "2a03:5840:111:1024:caca:caca:caca:0001/64"

     },

     {

        "name": "vitrine",

        "cpuunits": 256,

        "rootfs_size": "2G",

        "memory": 256,

        "ostemplate": "local:vztmpl/debian-12-standard_12.2-1_amd64.tar.zst",

        "ip6": "2a03:5840:111:1024:caca:caca:caca:0002/64"

     },

     {

        "name": "gestion",

        "cpuunits": 256,

        "rootfs_size": "2G",

        "memory": 256,

        "ostemplate": "local:vztmpl/debian-12-standard_12.2-1_amd64.tar.zst",

        "ip6": "2a03:5840:111:1024:caca:caca:caca:0003/64"

     }

     ]

}
```


### Paramètres Essentiels pour la Création d'une VM
1. **Nom de la VM (name)**
   1. **Description** : Identifie la machine virtuelle. Ce nom est utilisé pour distinguer cette VM des autres dans votre infrastructure.
   1. **Exemple** : "my-vm"
1. **CPU Units (cpuunits)**
   1. **Description** : Quantité d'unités CPU allouée à la VM. Plus le nombre est élevé, plus la VM reçoit de cycles CPU.
   1. **Exemple** : 256
1. **Taille du Système de Fichiers Racine (rootfs_size)**
   1. **Description** : Espace disque alloué pour le système d'exploitation et les fichiers système de la VM.
   1. **Exemple** : "20G" (20 gigaoctets)
1. **Mémoire (memory)**
   1. **Description** : Quantité de mémoire vive (RAM) allouée à la VM.
   1. **Exemple** : 2048 (2048 mégaoctets ou 2 Go)
1. **Modèle de Système d'Exploitation (ostemplate)**
   1. **Description** : Image ou modèle de système d'exploitation utilisé pour créer la VM.
   1. **Exemple** : "local:vztmpl/ubuntu-20.04-standard_20.04-1_amd64.tar.zst"
1. **Adresse IP (ip)**
   1. **Description** : Adresse IP assignée à la VM pour la connectivité réseau.
   1. **Exemple** : "192.168.1.100/24" pour IPv4 ou "2a03:5840:111:1024::1/64" pour IPv6

## Modification de Playbook package

### Modification des packages

Le fichier ` install_packages.yaml` permet de créer ou des packages sur les vm

Pour accéder à ce fichier, suivez ces étapes :

1. Allez dans le répertoire suivant en utilisant la commande :

```bash
   cd / /home/mbureau/Webmason-terraform/ansible/ansible-webmason/WebMason/playbooks   
```

2. Une fois dans ce dossier, vous pouvez modifier le fichier ` install_packages.yaml ` avec votre éditeur préféré.

Le contenu du fichier est le suivant : [./ansible/ansible-webmason/WebMason/playbooks/install_packages.yaml](./ansible/ansible-webmason/WebMason/playbooks/install_packages.yaml)



Pour ajouter ou supprimer une machine virtuelle, vous devez vous rendre dans le dossier host_vars et créer un fichier .yaml portant le nom de la VM. Pour accéder à ce fichier, suivez ces étapes :

1. Allez dans le répertoire suivant en utilisant la commande :

```bash
   cd / /home/mbureau/Webmason-terraform/ansible/ansible-webmason/WebMason/host_vars   
```

2. 
```bash
   Nano (nom de la vm).yaml
```


Exemple de contenue du fichier :

host: webmason-bdd.final.cfai24.ajformation.fr

login: root

- Pour host, vous devez entrer l'adresse IP du serveur ou le FQDN (Fully Qualified Domain Name).
- Pour login, il est recommandé d'utiliser root afin de disposer des permissions nécessaires pour installer les packages et gérer les utilisateurs.

### Déclarer une vm

Le fichier ` inventory.yaml ` permet de créer ou des packages sur les vm

Pour accéder à ce fichier, suivez ces étapes :

1. Allez dans le répertoire suivant en utilisant la commande :

```bash
     cd / /home/mbureau/Webmason-terraform/ansible/ansible-webmason/WebMason/host_vars   
```

2. Une fois dans ce dossier, vous pouvez modifier le fichier ` inventory.yaml ` avec votre éditeur préféré.

Contenu du fichier :





## Modification des utilisateur

Le fichier `all.yaml ` permet de créer ou des packages sur les vm

Pour accéder à ce fichier, suivez ces étapes :

1. Allez dans le répertoire suivant en utilisant la commande :

```bash
   cd /home/mbureau/Webmason-terraform/ansible/ansible-webmason/WebMason/group_vars   
```

2. Une fois dans ce dossier, vous pouvez modifier le fichier ` all.yaml ` avec votre éditeur préféré.

Contenu du fichier :



# Lien entre terraform et ansible

## 1. Configuration de Terraform
Dans le fichier container.tf, nous avons utilisé le provisioner local-exec pour appeler un script shell local après la création d'un conteneur LXC avec Proxmox. Cela garantit que les playbooks Ansible sont exécutés uniquement après la création réussie du conteneur.

## 2. Script Shell pour Exécuter les Playbooks Ansible
Un script shell (run_ansible.sh) est utilisé pour configurer l'environnement et exécuter les playbooks Ansible. Voici ce que fait ce script :

- **Tronquer le fichier known_hosts** : Supprime les anciennes entrées d'hôtes connus pour éviter les conflits SSH.
- **Attendre 20 secondes** : Assure que le conteneur LXC est prêt avant de continuer.
- **Changer de répertoire** : Se déplace vers le répertoire contenant les playbooks Ansible.
- **Exécuter le script Expect** : Appelle un script Expect pour gérer les commandes interactives nécessaires à l'exécution des playbooks Ansible.

## 3. Script Expect pour Gérer les Demandes de Mot de Passe
Un script Expect est utilisé pour automatiser l'exécution des playbooks Ansible nécessitant une entrée de mot de passe. Ce script gère les invites interactives telles que l'entrée du mot de passe BECOME et la confirmation des connexions SSH.

Voici ce que fait le script Expect :

- **Première exécution du playbook** : Exécute un playbook nécessitant un mot de passe BECOME.
- **Deuxième exécution du playbook** : Exécute un deuxième playbook avec des options détaillées et gère la confirmation de connexion SSH sans mot de passe.

# Lancé la création et la configuration des VM

Pour lancer la création et la configuration automatique, il suffit de se rendre dans le fichier « terraform » en exécutant la commande suivante :

```bash
cd /home/mbureau/Webmason-terraform/terraform/
```
Exécutez la commande suivante :

```bash
source password.env
```
Ensuite, exécutez la commande suivante :

```bash
./terraform apply
```

Quand la question « Enter a value: » s'affiche, répondez par « yes ».

Une fois cette étape réalisée, il faudra attendre environ 5 minutes pour que les machines virtuelles soient créées et configurées.

Pour vérifier que tout a fonctionné, vous pouvez accéder aux sites web suivants :

- [Site web de la base de donnée phpMyAdmin](http://webmason-bdd.final.cfai24.ajformation.fr)
- [Site web vitrine de l'entreprise](http://webmason-vitrine.final.cfai24.ajformation.fr)
- [Site de gestion de l'entreprise](http://webmason-gestion.final.cfai24.ajformation.fr)
